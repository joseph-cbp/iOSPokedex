name: iOS CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

# Cancela workflows anteriores da mesma branch se houver novo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test iOS App
    runs-on: macos-14  # Xcode 15.x (sempre use a versÃ£o mais recente estÃ¡vel)
    
    strategy:
      matrix:
        # Teste em mÃºltiplos devices/OS se necessÃ¡rio
        destination:
          - platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2
        # Descomente para testar mÃºltiplas versÃµes:
        # - platform=iOS Simulator,name=iPhone 14,OS=16.4
    
    env:
      SCHEME: "PokedexProject"  # âš ï¸ AJUSTE AQUI
      # WORKSPACE: "SeuApp.xcworkspace"  # âš ï¸ OU use PROJECT se nÃ£o tiver workspace
      PROJECT: "PokedexProject.xcodeproj"  # Use esta linha se nÃ£o tiver workspace
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Seleciona a versÃ£o correta do Xcode
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      # 3. Exibe informaÃ§Ãµes do ambiente (debug)
      - name: Show environment info
        run: |
          xcodebuild -version
          swift --version
          xcrun simctl list devices available
      
      # 4. Cache de dependÃªncias (CocoaPods/Carthage/SPM)
      - name: Cache CocoaPods
        uses: actions/cache@v4
        if: hashFiles('Podfile.lock') != ''
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      
      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      # 5. Instala dependÃªncias (se usar CocoaPods)
      - name: Install dependencies
        if: hashFiles('Podfile') != ''
        run: |
          gem install cocoapods -v 1.15.2
          pod install --repo-update
      
      # 6. Build e testes com cobertura
      - name: Build and Test
        run: |
          xcodebuild clean test \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "${{ matrix.destination }}" \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            -parallel-testing-enabled YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty --color --report html --output build/reports/tests.html
        
        # Se usar PROJECT ao invÃ©s de WORKSPACE, troque a linha acima por:
        # -project "$PROJECT" \
      
      # 7. Gera relatÃ³rio de cobertura
      - name: Generate Code Coverage Report
        if: success()
        run: |
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json
          xcrun xccov view --report DerivedData/Logs/Test/*.xcresult
      
      # 8. Upload dos resultados
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/
            coverage.json
            TestResults.xcresult
            xcodebuild.log
          retention-days: 30
      
      # 9. Comenta no PR com resultado dos testes (opcional)
      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let coverage = 'N/A';
            try {
              const data = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
              coverage = `${(data.lineCoverage * 100).toFixed(2)}%`;
            } catch (e) {}
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§ª Test Results\n\nâœ… Tests passed!\nðŸ“Š Code Coverage: ${coverage}`
            })

  # Job adicional: SwiftLint
  lint:
    name: SwiftLint
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run SwiftLint
        run: |
          brew install swiftlint
          swiftlint lint --reporter github-actions-logging
